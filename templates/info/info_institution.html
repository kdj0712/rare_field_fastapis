{% extends "maintemplate.html" %}

{% block main_container %}

<form action="" id="maps" class="container" method="get">
  <div class="container">
    <div class="row">
      <div class="col-12" id="map" style="width: 100%; height: 600px;"></div>
      <div class="col-12">
        <label for="keyword">검색할 장소를 입력하세요</label>
        <input type="text" id="keyword" name="keyword" class="controls" placeholder="입력하기"
          value="{{request._query_params.keyword}}">
        <input type="hidden" id="pos" name="pos" value="pos">
        <button type="summit" formmethod="get" onclick="getLocationAndSubmit()">Search</button>
        <div class="row">
          <table id="places">
            <thead>
              <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Tel Num</th>
                <th>자세히 보기</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
            {% for result in results %}
            <tr>
              <td>{{result.yadmNm}}</td>
              <td>{{result.addr}}</td>
              <td>{{result.telno}}</td>
              <td><a href="#" onclick="focusOnMap({{index}}); return false;">보기</a>
              <input type="hidden" name="resultId" value="{{result.ykiho}}">
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>
        {% if results=={} %}
        <h5>검색 결과가 없습니다.</h5>
        {% endif %}
      </div>
    </div>
  </div>
</form>
{% endblock main_container%}


{% block js %}
<script type="text/javascript">
  var resultsFromPython = {{ results | tojson | safe }};
</script>
<script>
  let map, service, infowindow, pos, yPos, xPos;

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(sendPositionToServer, showError);
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }
  function getLocationAndSubmit() {
    navigator.geolocation.getCurrentPosition(
      async function (position) {
        const yPos = position.coords.latitude.toString();
        const xPos = position.coords.longitude.toString();
        const pos = `${yPos},${xPos}`;
        document.getElementById('pos').value = pos;
        const keyword = document.getElementById('keyword').value; 
        document.getElementById('maps').submit();
      },
      function (error) {
        console.error('Geolocation error:', error);
        alert('위치 정보를 가져오는 데 실패했습니다. 다시 시도해 주세요.');
      }
    );
  }

  document.addEventListener('DOMContentLoaded', function () {
    checkPosValue();
  });

  function checkPosValue() {
    const posValue = document.getElementById('pos').value;
    if (!posValue) {
      alert('위치 정보가 필요합니다. "Search" 버튼을 클릭해서 위치 정보를 제공해주세요.');
    }
  }
  function initMap() {
    var map;
    var infowindow = new google.maps.InfoWindow();

    function success(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      map = new google.maps.Map(document.getElementById('map'), {
        center: pos,
        zoom: 15,
        draggable: true,
        zoomControl: true,
      });

      hospitals.forEach(function (hospital) {
        var marker = new google.maps.Marker({
          position: { lat: parseFloat(hospital.YPos), lng: parseFloat(hospital.XPos) },
          map: map,
          title: hospital.yadmNm
        });
      });
    }

    function error() {
      var defaultPos = { lat: 37.5665, lng: 126.9780 };
      map = new google.maps.Map(document.getElementById('map'), {
        center: defaultPos,
        zoom: 15
      });

      infowindow.setPosition(defaultPos);
      infowindow.setContent('Error: Geolocation failed.');
      infowindow.open(map);
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(success, error);
    } else {
      error();
    }
  }
  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    pos = { lat: 37.5665, lng: 126.9780 };
    map = new google.maps.Map(document.getElementById('map'), {
      center: pos,
      zoom: 15,
    });

    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
      'Error: The Geolocation service failed.' :
      'Error: Your browser doesn\'t support geolocation.');
    infoWindow.open(map);
  }
  let markers = [];

  function createMarker(results) {
    if (!results.geometry || !results.geometry.location) return;
    const marker = new google.maps.Marker({
      map,
      position: results.geometry.location,
    });

    google.maps.event.addListener(marker, 'click', function () {
      infowindow.setContent(results.name);
      infowindow.open(map, this);
    });
  }
    function displayResultsOnMap(results, map) {
    results.forEach((hospital) => {
      const marker = new google.maps.Marker({
        position: { lat: hospital.YPos, lng: hospital.XPos }, // 수정됨
        map: map,
        title: hospital.yadmNm // 수정됨
      });
      markers.push(marker);

      marker.addListener('click', () => {
        const infoWindow = new google.maps.InfoWindow({
          content: `${hospital.yadmNm}<br> ${hospital.addr}` // 수정됨
        });
        infoWindow.open(map, marker);
      });
      
    });
  }

  function requestUserLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const userPos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };
        
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13,
          center: userPos,
        });
        displayResultsOnMap(resultsFromPython, map);
      });
    }
  }

  function focusOnMap(index,map) {
  const marker = markers[index]; // 전역 마커 배열에서 마커를 가져옴
  map.setCenter(marker.getPosition());
  map.setZoom(16); // 확대 수준을 조정할 수 있음
  }

  window.onload = requestUserLocation;
</script>
<!-- Google Maps API Script -->
<script async src="https://maps.googleapis.com/maps/api/js?key={{ API_KEY }}&libraries=places&callback=initMap&language=ko"></script>
{% endblock js %}